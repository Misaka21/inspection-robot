![...](..\..\TCP-IP%20API\附录\images\3D%20地图格式.001.png)

**3D 地图格式**

**一、文件格式**

3d地图后缀为smap，实际是一个zip压缩包，包含三个文件：

- info.json
- 0.smap
- 0.3dsmap

用于描述地图及其元信息。三个文件均应位于压缩包根目录。

**二、文件说明**

\1. **info.json**

- 类型：JSON 格式文本文件
- 作用：存放数据包基本信息
- json数据：

```字段名|类型|描述|可缺省``` :- | :- | :- |
|zipName|string|20250606165847531-3D|否|
示例：

```JSON
{
    "zipName": "20250606165847531-3D"
}```
\2. **0.smap** 

- 类型：JSON 格式文本文件
- 内容：2D格式地图，参见[附录C: 地图格式](https://shimo.im/docs/0m8AZVlgBJOF5Aba/read)

\3. **0.3dsmap 文件**

- 类型：ProtoBuf 序列化的二进制文件
- 内容：3D地图信息
- 格式：Message\_Map3D

```Bash
syntax = "proto3";

package rbk.protocol;

import "google/protobuf/wrappers.proto";
import "message\_header.proto";
import "message\_imu.proto";
import "message\_gnss.proto";
import "message\_localization.proto";

message Message\_MapLogData {
  double robot\_odo\_x = 1;
  double robot\_odo\_y = 2;
  double robot\_odo\_w = 3;
  repeated double laser\_beam\_dist = 4;
  repeated double laser\_beam\_angle = 5;
  repeated double rssi = 6;
  Message\_Header header = 7;
}

message Message\_MapOdo {
  double timestamp = 1;
  float odo\_x = 2;
  float odo\_y = 3;
  float odo\_w = 4;
  float odo\_vx = 5;
  float odo\_vy = 6;
  float odo\_vw = 7;
}

message Message\_MapLogData3D {
  double timestamp = 1;
  repeated float x = 2;
  repeated float y = 3;
  repeated float z = 4;
  repeated uint32 intensity = 5;
  repeated uint32 timeoffset = 6;
  repeated uint32 ring = 7;
  repeated bytes data = 8;
  repeated float firstAzimuth = 9;
  repeated float secondAzimuth = 10;
}

message Message\_MapLog {
  double laser\_pos\_x = 1;
  double laser\_pos\_y = 2;
  double laser\_pos\_z = 3;//由于版本原因里面设置是激光安装yaw角，取激光高度数据从laser\_install\_height
  double laser\_step = 4;
  double laser\_range\_max = 5;
  repeated Message\_MapLogData log\_data = 6;
  string laser\_name = 7;
  double laser\_install\_height = 8;
  repeated Message\_MapOdo odometer = 9;
  repeated Message\_MapLogData3D log\_data3d = 10;
  double laser\_install\_yaw = 11;
  double laser\_install\_pitch = 12;
  double laser\_install\_roll = 13;
  repeated Message\_IMU imu\_data = 14;
  repeated Message\_GNSS gnss\_data = 15;
  uint32 lasertype = 16; // lasertype = 1---robosense 16  lasertype = 2----robosense helios   lasertype = 3----velodyne 16
  float factor = 17;
  repeated float azimuthcorrection = 18;
  repeated float verticalcorrection = 19;
  repeated Message\_AllGNSS all\_gnss\_data = 20; // 支持多个天线设备
  repeated Message\_Localization localization\_data = 21;
}

message Message\_MapProperty {
  string key = 1;
  string type = 2; //如果type = "json"时,表示 string\_value中是个json的string 方便以后扩展
  bytes value = 3; // for backward compatibility
  oneof oneof\_value {
    string string\_value = 4;
    bool bool\_value = 5;
    int32 int32\_value = 6;
    uint32 uint32\_value = 7;
    int64 int64\_value = 8;
    uint64 uint64\_value = 9;
    float float\_value = 10;
    double double\_value = 11;
    bytes bytes\_value = 12;
  }
  string tag = 13; //调度场景专用表示该key作用于指定机器人组(例如: "group:test\_1,group1:test\_2,group2")如果为空表示作用于所有机器人
}

message Message\_MapPos {
  double x = 1;
  double y = 2;
  double z = 3;
}

message Message\_MapRSSIPos {
  double x = 1;
  double y = 2;
}

message Message\_ReflectorPos {
  string type = 1;
  double width = 2;
  double x = 3;
  double y = 4;
  uint32 creation\_method = 5;//创建方式:creation\_method(0:手动添加  1:建图时生成  2:修改过)
}

message Message\_LiveRefPos {
  repeated Message\_ReflectorPos ref\_pos = 1;
}
message Message\_tagPos {
  uint32 tag\_value = 1;
  double x = 2 ;
  double y = 3;
  double angle = 4 ;
  bool is\_DMT\_detected = 5;
  double z = 6;
  double qx = 7;
  double qy = 8;
  double qz = 9;
  double qw = 10;
  double variance = 11;
  string class\_name = 12;  //2DTAG,3DTAG
  repeated Message\_MapProperty property = 13;
}

message Message\_MapLine {
  Message\_MapPos start\_pos = 1;
  Message\_MapPos end\_pos = 2;
}

message Message\_MapHeader {
  string map\_type = 1;    //type of map: 2D-Map or 3D-Map
  string map\_name = 2;    //name of map: the map file name
  Message\_MapPos min\_pos = 3;
  Message\_MapPos max\_pos = 4;
  double resolution = 5; //unit: m
  string version = 8;
}

message Message\_MapAttribute {
  string description = 1; // description of the this class
  uint32 color\_pen = 2;
  uint32 color\_brush = 3;
  uint32 color\_font = 4;
}

message Message\_AdvancedPoint {
  string class\_name = 1;    //the class\_name from the Message\_AdvancedObjectDefine
  string instance\_name = 2; // the name of this instance
  Message\_MapPos pos = 3;
  double dir = 4;
  repeated Message\_MapProperty property = 5; // write in json
  bool ignore\_dir = 6;
  bytes desc = 8;
  Message\_MapAttribute attribute = 10;
}

message Message\_AdvancedLine {
  string class\_name = 1;   //the class\_name from the Message\_AdvancedObjectDefine
  string instance\_name = 2;// the name of this instance
  Message\_MapLine line = 3;
  repeated Message\_MapProperty property = 4; // write in json
  bytes desc = 8;
  Message\_MapAttribute attribute = 10;
}

message Message\_AdvancedCurve {
  string class\_name = 1;   //the class\_name from the Message\_AdvancedObjectDefine
  string instance\_name = 2;// the name of this instance
  Message\_AdvancedPoint start\_pos = 3;
  Message\_AdvancedPoint end\_pos = 4;
  Message\_MapPos control\_pos1 = 5;
  Message\_MapPos control\_pos2 = 6;
  repeated Message\_MapProperty property = 7; // write in json
  bytes desc = 8;
  Message\_MapPos control\_pos3 = 9;
  Message\_MapPos control\_pos4 = 10;
  repeated Message\_Device devices = 12;
  Message\_MapAttribute attribute = 15;
}

message Message\_AdvancedArea {
  string class\_name = 1;//the class\_name from the Message\_AdvancedObjectDefine
  string instance\_name = 2;// the name of this instance
  repeated Message\_MapPos pos\_group = 3; // usually four lines in a group
  double dir = 4;
  repeated Message\_MapProperty property = 5; // write in json
  bytes desc = 8;
  repeated Message\_Device devices = 10;
  Message\_MapAttribute attribute = 15;
}

message Message\_VirtualLineList {
  repeated Message\_MapLine virtual\_map\_line = 1;
}

message Message\_LaserDevice {
  uint32 id = 1;
  repeated Message\_MapPos laser\_margin\_pos = 2;
}

message Message\_Device {
  string model\_name = 1;
  repeated Message\_LaserDevice laser\_devices = 5;
  repeated double ultrasonic\_dist = 6; // dist = -1 means not used
  repeated double fallingdown\_dist = 7; // dist = -1 means not used
}

message Message\_PatrolRouteStation {
  string id = 1;
}

message Message\_PatrolRoute {
  string name = 1;
  repeated Message\_PatrolRouteStation station\_list = 2;
  google.protobuf.DoubleValue max\_speed = 4;
  google.protobuf.DoubleValue max\_acc = 5;
  google.protobuf.DoubleValue max\_rot = 6;
  google.protobuf.DoubleValue max\_rot\_acc = 7;
  bytes desc = 8;
  google.protobuf.DoubleValue max\_dec = 9;
  google.protobuf.DoubleValue max\_rot\_dec = 10;
}

message Message\_Primitive {
  string class\_name = 1;   //the class\_name from the Message\_AdvancedObjectDefine
  string instance\_name = 2;// the name of this instance
  Message\_AdvancedPoint start\_pos = 3;
  Message\_AdvancedPoint end\_pos = 4;
  repeated Message\_MapPos control\_pos\_list = 5;
  repeated Message\_MapProperty property = 6; // write in json
  bytes desc = 7;
  Message\_MapAttribute attribute = 8;
}

message Message\_ExternalDevice {
  string class\_name = 1;   //the class\_name from the Message\_AdvancedObjectDefine
  string instance\_name = 2;// the name of this instance
  bool is\_enabled = 3;
  repeated Message\_MapProperty property = 4; // write in json
  bytes desc = 5;
  Message\_MapAttribute attribute = 6;
}
message Message\_BinLocation {//库位
  string class\_name = 1;                        //库位class\_name
  string instance\_name = 2;                     //库位唯一值
  string group\_name = 3;                        //库区名称 //弃用，已移到 message\_rds\_scene.proto中
  string point\_name = 4;                        //关联的站点名称
  Message\_MapPos pos = 5;
  repeated Message\_MapProperty property = 6;    //拓展属性
  bytes desc = 7;
  Message\_MapAttribute attribute = 8;
}

message Message\_BinLocations {//库位数组   (x,y相同的库位放到一个数组中)
  repeated Message\_BinLocation bin\_location\_list = 1;//库位
}

message Message\_Map {
  string map\_directory = 1;
  Message\_MapHeader header = 2;
  repeated Message\_MapPos normal\_pos\_list = 3;              //普通点
  repeated Message\_MapLine normal\_line\_list = 4;            //普通线
  repeated Message\_MapPos normal\_pos3d\_list = 5;            //普通3d点云
  repeated Message\_AdvancedPoint advanced\_point\_list = 6;   //站点
  repeated Message\_AdvancedLine  advanced\_line\_list = 7;    //禁行线
  repeated Message\_AdvancedCurve advanced\_curve\_list = 8;   //连接线
  repeated Message\_AdvancedArea  advanced\_area\_list = 9;    //高级区域
  repeated Message\_PatrolRoute patrol\_route\_list = 10;      //
  repeated Message\_MapRSSIPos rssi\_pos\_list = 11;           //反光板点
  repeated Message\_ReflectorPos reflector\_pos\_list = 12;    //反光板/反光柱
  repeated Message\_tagPos tag\_pos\_list = 13;                //二维码
  repeated Message\_Primitive primitive\_list = 14;           //图元
  repeated Message\_ExternalDevice external\_device\_list = 15; //外部设备
  repeated Message\_BinLocations bin\_locations\_list = 16;     //库位

  repeated Message\_MapProperty user\_data = 100;              //支持地图中自定义一些属性
}

message Message\_Map3D {
  string map\_directory = 1;
  Message\_MapHeader header = 2;
  repeated Message\_MapPos normal\_pos3d\_list = 3;            // 普通3d点云
  FeatureMap3D feature\_map\_3d = 4;                          // 3D 特征地图
}

// =================== 多线激光特征定位相关 begin
message Vec3f {
  float x = 1;
  float y = 2;
  float z = 3;
}

message Vec3i {
  int32 x = 1;
  int32 y = 2;
  int32 z = 3;
}

message FeatureMapParams {
  // 激光测量距离的标准差，单位m
  float ranging\_sigma = 1;
  // 激光测量角度的标准差，单位deg
  float angle\_sigma = 2;
  // 体素最大的边长，单位m
  float max\_voxel\_size = 3;
  // 体素的最大层数
  uint32 max\_layer = 4;
  // 不再更新平面协方差的点数门限
  uint32 cov\_fixed\_pts\_num = 5;
  // 不再更新平面的点数门限
  uint32 plane\_fixed\_pts\_num = 6;
  // 有效平面协方差最小特征值的门限
  float plane\_min\_eigen\_value = 7;
  // 体素每层对应评估平面最少所需的点数
  repeated int32 each\_layer\_least\_pts\_num = 8;
}

message FeatureMapPlane {
  // 平面的重心
  Vec3f center = 1;
  // 平面法向量
  Vec3f normal = 2;
  //平面方程 Ax + By + Cz + D = 0
  float d = 3;
  // 评估的平面半径
  float radius = 4;
  // 平面协方差 6x6
  repeated float plane\_cov = 5;
}

message OctoTree {
  // 对应的平面ID
  uint32 plane\_id = 1;
  // 子节点的序列，依次从最外层到当前层
  // -1 表示当前层下无其他子节点
  repeated int32 child\_id\_list = 2;
}

// 当前位置的八叉树容器， 可能包含很多很多子节点
message OctoTrees {
  repeated OctoTree octo\_tree = 1;
}

message FeatureMap3D {
  FeatureMapParams params = 1;
  repeated FeatureMapPlane planes = 2;
  repeated OctoTrees octo\_trees = 3;
  // 最外层的八叉树位置
  repeated Vec3i voxel\_locs = 4;
}

// end 多线激光特征定位相关 ===================```


