一 Github 仓库
我司已将地图格式描述文件、各种地图样例文件、 Protobuf(v3.6.1.3) 读取并解析地图的代码示例存放于 Github 公有仓库，可供参考及测试，地址为： https://github.com/seer-robotics/smap
二 简介
.smap 文件为我司自定义的地图文件，其本质为标准 JSON 格式的文本文件，肉眼是可读的。使用 VS Code 或 Sublime Text 之类的文本编辑软件打开即可看到具体的文件内容，如下图：

[图片]

该 JSON 格式的文件是用 Protobuf 生成的，即在程序中，地图是以 Protobuf 结构体的形式存在的，仅在保存为文件时，才导出为 JSON 格式。
对于用户想自己解析地图时，既可以使用 Protobuf，也可以单纯的使用 JSON 库来直接解析地图文件。
JSON 的具体信息请参阅 JSON 官网 ，网站中也列出了各种编程语言常用的 JSON 库。
注：
1. 地图中的坐标点的单位均为米，会保留三位或三位以上小数，即精确到 0.001m
2. 地图的坐标系即为世界坐标系
三 地图的 Protobuf 格式
Protobuf3 请参阅 Google 官方文档 。
Protobuf 的仓库地址为 https://github.com/protocolbuffers/protobuf
syntax = "proto3";
package rbk.protocol;
import "google/protobuf/wrappers.proto";
import "message_header.proto";

message Message_MapProperty {
    
    string key = 1;  // 属性名
    string type = 2; // 属性值的类型, 这里 type 一定是 string, bool, int(int32), uint(uint32), int64, uint64, float, double, bytes,json(如果为json时则取string_value)
    bytes value = 3; // 属性值 (已废弃, for backward compatibility)
    oneof oneof_value { // 属性值
    string string_value = 4;
    bool bool_value = 5;
    int32 int32_value = 6;
    uint32 uint32_value = 7;
    int64 int64_value = 8;
    uint64 uint64_value = 9;
    float float_value = 10;
    double double_value = 11;
    bytes bytes_value = 12;
}

}

// 普通点

message Message_MapPos {
    double x = 1;
    double y = 2;
}

// 反光板点

message Message_MapRSSIPos {
    double x = 1;
    double y = 2;
}

message Message_ReflectorPos {
    string type = 1;
    double width = 2;
    double x = 3;
    double y = 4;
}



message Message_LiveRefPos {
    repeated Message_ReflectorPos ref_pos = 1;
}

message Message_tagPos{
    uint32 tag_value = 1;
    double x = 2 ;
    double y = 3;
    double angle =4 ;
    bool is_DMT_detected = 5;
}

// 普通线

message Message_MapLine {
    Message_MapPos start_pos = 1; // 线的起始点
    Message_MapPos end_pos = 2;  // 线的终止点
}

// 地图元数据

message Message_MapHeader {
    string map_type = 1;   // type of map: 2D-map or 3D-map
    string map_name = 2;  // name of map: the map file name
    Message_MapPos min_pos = 3; // 地图中 x,y 最小值, 该点不一定存在, 只是指示包含增长地图的矩形的左下点
    Message_MapPos max_pos = 4; // 地图中 x,y 最大值, 该点不一定存在, 只是指示包含增长地图的矩形的右上点
    double resolution = 5; // 分辨率 (m), 一般为 0.02 或 0.05
    string version = 8; // 地图的格式的版本号, 目前只支持 1.0.x
}

// 暂时无用，用户不必关注该条目

message Message_MapAttribute {
    string description = 1; // description of the this class
    uint32 color_pen = 2;
    uint32 color_brush = 3;
    uint32 color_font = 4;
}

// 高级点
message Message_AdvancedPoint {
    string class_name = 1;   // 高级点的类型, 目前只有 LocationMark(普通站点), ChargePoint(充电点), ParkPoint(停靠点), ActionPoint(动作点), TransferLocation(运输点), WorkLocation(工作点)
    string instance_name = 2; // 唯一标识名
    Message_MapPos pos = 3;  // 点
    double dir = 4;      // 方向
    repeated Message_MapProperty property = 5; // 高级点的属性
    bool ignore_dir = 6;         // 是否忽略方向
    bytes desc = 8;           // 描述
    Message_MapAttribute attribute = 10; // 暂时无用
}

// 高级线

message Message_AdvancedLine {
    string class_name = 1;  // 高级线的类型, 目前只有 ForbiddenLine
    string instance_name = 2; // 唯一标识名
    Message_MapLine line = 3; // 线
    repeated Message_MapProperty property = 4; // 高级线的属性
    bytes desc = 8;           // 描述
    Message_MapAttribute attribute = 10; // 暂时无用
}



// 高级曲线(用于连接两个高级点)
message Message_AdvancedCurve {
    string class_name = 1;  // 高级曲线的类型, 目前只有 BezierPath(三阶贝塞尔曲线)，ArcPath(圆弧)，StraightPath(直线) 三种
    string instance_name = 2; // 唯一标识名
    Message_AdvancedPoint start_pos = 3; // 曲线起始点(是某个高级点,一定是地图中出现过的某个高级点)
    Message_AdvancedPoint end_pos = 4;  // 曲线终止点(是某个高级点,一定是地图中出现过的某个高级点)
    Message_MapPos control_pos1 = 5;   // 曲线控制点1（BezierPath 的第一个控制点，或 ArcPath 的唯一控制点，StraightPath 无控制点）
    Message_MapPos control_pos2 = 6;   // 曲线控制点2（BezierPath 的第二个控制点）
    repeated Message_MapProperty property = 7; // 高级曲线的属性
    bytes desc = 8;            // 描述
    Message_MapPos control_pos3 = 9;    // 曲线控制点3（暂时无用）
    repeated Message_Device devices = 12; // 暂时无用
    Message_MapAttribute attribute = 15;  // 暂时无用
}



// 高级区域
message Message_AdvancedArea {
    string class_name = 1;  // 高级区域的类型，目前只有 AdvancedArea(高级属性区域)，ReflectorArea(反光板区域)，DOArea(DO控制区域)，DIArea(DI控制区域)
    string instance_name = 2; // 唯一标识名
    repeated Message_MapPos pos_group = 3; // 区域边界线
    double dir = 4;            // 方向
    repeated Message_MapProperty property = 5; // 高级区域的属性
    bytes desc = 8;            // 描述
    repeated Message_Device devices = 10; // 暂时无用
    Message_MapAttribute attribute = 15;  // 暂时无用
}

// 暂时无用，用户不必关注该条目

message Message_VirtualLineList {
    repeated Message_MapLine virtual_map_line = 1;
}

// 暂时无用，用户不必关注该条目

message Message_LaserDevice {
    uint32 id = 1;
    repeated Message_MapPos laser_margin_pos = 2;
}



// 暂时无用，用户不必关注该条目

message Message_Device {
    string model_name = 1;
    repeated Message_LaserDevice laser_devices = 5;
    repeated double ultrasonic_dist = 6;
    repeated double fallingdown_dist = 7;
}

// 暂时无用，用户不必关注该条目

message Message_PatrolRouteStation {
    string id = 1;
}

// 暂时无用，用户不必关注该条目

message Message_PatrolRoute {
    string name = 1;
    repeated Message_PatrolRouteStation station_list = 2;
    google.protobuf.DoubleValue max_speed = 4;
    google.protobuf.DoubleValue max_acc = 5;
    google.protobuf.DoubleValue max_rot = 6;
    google.protobuf.DoubleValue max_rot_acc = 7;
    bytes desc = 8;
    google.protobuf.DoubleValue max_dec = 9;
    google.protobuf.DoubleValue max_rot_dec = 10;
}



// 地图

message Message_Map {
    string map_directory = 1;   // 暂时无用
    Message_MapHeader header = 2; // 元数据，用户无需关注
    repeated Message_MapPos normal_pos_list = 3; // 普通点数组
    repeated Message_MapLine normal_line_list = 4; // 普通线数组
    repeated Message_AdvancedPoint advanced_point_list = 6; // 高级点数组
    repeated Message_AdvancedLine advanced_line_list = 7; // 高级线数组
    repeated Message_AdvancedCurve advanced_curve_list = 8; // 高级曲线数组
    repeated Message_AdvancedArea advanced_area_list = 9; // 高级区域数组
    repeated Message_PatrolRoute patrol_route_list = 10;  // 暂时无用
    repeated Message_MapRSSIPos rssi_pos_list = 11;     // 反光板点数组
    repeated Message_ReflectorPos reflector_pos_list = 12;
    repeated Message_tagPos tag_pos_list = 13;
}

地图的 JSON 格式是从 Protobuf 格式转换而来, JSON 和 Protobuf 格式可以相互转换, 转换按照 Protobuf3 的 规则 。
注：
1. 注释中 [] 表示这个 key 一定存在（除非遇到数值是默认值的情况，见注 3），() 小括号表示可缺省
2. 从 Protobuf 转为 JSON 后，key 将从下划线分隔变为小驼峰形式，如 ignore_dir 变为 ignoreDir
3. 我们使用 Protobuf 导出 JSON 格式地图文件时将 always_print_primitive_fields 选项置为了 false , 因此对于一些类型的默认值（如 int = 0, bool = false, string = ""）将不会出现在 JSON 格式的地图文件中（如下文中的 dir 和 ignoreDir），具体的默认值说明请看 Google 官方 。
四、地图格式解析
4.1 MapHeader 地图头部
{
  "mapType": "2D-Map", // [string] 2D-Map or 3D-Map，目前只支持2D-Map
  "mapName": "seer",  // [string] 地图的名字，不含 .smap 后缀
  "minPos": {      // [MapPos] 地图中可以囊括整个地图的左上点（不一定实际存在这个点），类型是一个 MapPos
       "x": -43.812,
       "y": -70.232
     },
  "maxPos": {      // [MapPos] 地图中可以囊括整个地图的右下点（不一定实际存在这个点），类型是一个 MapPos
       "x": 166.321,
       "y": 86.600
 },
  "resolution": 0.02,  // [double] 分辨率(m)
  "version": "1.0.6"  // [string] 版本号, 目前为 1.0.6
}

4.2 MapProperty 属性
属性都是跟软件 GUI 或者算法相关的，用户不必理会。
{
  "key": "spin",  // [string]
  "type": "int32", // [string]
  "value": "MQ==", // [string] 这里的值需要将类型转换为 string, 再进行 base64 编码, 如 int32 = 1, 转换为 string 是 "1", 进行 base64 编码后为 "MQ=="
  "int32Value": 1  // 该字段会根据 type 变化, 可能为 stringValue, boolValue, int32Value, uint32Value, int64Value, uint64Value, floatValue, doubleValue, bytesValue
}
4.3 MapPos 普通点
{
  "x": 10.111, // [double] 世界坐标系中 x 坐标(m)
  "y": 2.222,  // [double] 世界坐标系中 y 坐标(m)
}
4.4 RSSIPos 反光板点
{
  "x": 4.111,  // [double] 世界坐标系中 x 坐标(m)
  "y": 5.222,  // [double] 世界坐标系中 y 坐标(m)
}

4.5 MapLine 普通线
{
  "startPos": {   // [MapPos], 是该线段的起始点，类型是一个 MapPos
    "x": 1.123,
    "y": 2.123
  },
  "endPos": {    // [MapPos], 是该线段的终止点，类型是一个 MapPos
    "x": 3.321,
    "y": 5.123
  }
}

4.6 AdvancedPoint 高级点
{   //LocationMark,ParkPoint,ActionPoint,TransferLocation,WorkingLocation,ChargePoint,...
    "className": "LocationMark", // [string] 高级点类型
    "instanceName": "1", // [string] 高级点唯一标识名
    "pos": {
        "x": 18.420,
        "y": 9.270
    }, // [MapPos]
    "dir": 0.894, // (double) 方向(rad)
    "property": [{ // (MapProperty[]) 属性数组
        "key": "spin",
        "type": "int32",
        "value": "MQ==",
        "int32Value": 1
    }],
    "ignoreDir": false // (bool) 是否忽略方向
}
4.7 AdvancedLine 高级线
{
    "className": "ForbiddenLine", // [string] 高级线类型
    "instanceName": "2", // [string] 高级线唯一标识名
    "line": { // [MapLine]
        "startPos": {
            "x": 50.970,
            "y": 28.460
        },
        "endPos": {
            "x": 74.690,
            "y": 28.460
        }
    },
    "property": [{ // (MapProperty[]) 属性数组
        "key": "spin",
        "type": "int32",
        "value": "MQ==",
        "int32Value": 1
    }]
}
4.8 AdvancedCurve 高级曲线
3 阶贝塞尔曲线
className:"BezierPath"
{
  "className": "BezierPath",     // [string] 高级曲线类型
  "instanceName": "LM1-LM2",        // [string] 唯一标识名
  "startPos": {           // [AdvancedPoint] 贝塞尔曲线起始点,一定是地图中出现过的某个高级点
  "instanceName": "LM1",
  "pos": {"x": 22.415, "y": 38.104}
  },
  "endPos": {            // [AdvancedPoint] 贝塞尔曲线终止点,一定是地图中出现过的某个高级点
    "instanceName": "LM2",
    "pos": {"x": 22.297, "y": 14.284}
 },
  "controlPos1": {"x": 22.009, "y": 28.664}, // [MapPos] 贝塞尔曲线控制点1
  "controlPos2": {"x": 22.369, "y": 20.501}, // [MapPos] 贝塞尔曲线控制点2
    "property": [{  //MapProperty
           "key": "direction", //0正走 1倒走
           "type": "int",
           "value": "MA==",
           "int32Value": 0 
       }, 
       {
           "key": "movestyle",//导航类型
           "type": "int",
           "value": "MA==",
           "int32Value": 0 
       }]
}
圆弧
className: "ArcPath" {
    "className": "ArcPath", // [string] 高级曲线类型
    "instanceName": "LM1-LM4", // [string] 唯一标识名
    "startPos": { // [AdvancedPoint] 圆弧起始点,一定是地图中出现过的某个高级点
        "instanceName": "LM1",
        "pos": {
            "x": 22.415,
            "y": 38.104
        }
    },
    "endPos": { // [AdvancedPoint] 圆弧终止点,一定是地图中出现过的某个高级点
        "instanceName": "LM4",
        "pos": {
            "x": 22.297,
            "y": 14.284
        }
    },
    "controlPos1": {
        "x": 22.009,
        "y": 28.664
    }, // [MapPos] 圆弧控制点
    "property": [] // (MapProperty[]) 属性数组
}
直线
className: "StraightPath"
{
    "className": "StraightPath", // [string] 高级曲线类型
    "instanceName": "LM2-LM3", // [string] 唯一标识名
    "startPos": { // [AdvancedPoint] 直线起始点,一定是地图中出现过的某个高级点
        "instanceName": "LM2",
        "pos": {
            "x": 47.638,
            "y": -60.631
        }
    },
    "endPos": { // [AdvancedPoint] 直线终止点,一定是地图中出现过的某个高级点
        "instanceName": "LM3",
        "pos": {
            "x": 49.361,
            "y": -60.631
        }
    },
    "property": [] // (MapProperty[]) 属性数组
}
圆弧线
className: "RoundLine"
"primitiveList": [
    {
        "className": "RoundLine", //圆弧线
        "instanceName": "LM1-LM2",
        "startPos": { //起点
            "instanceName": "LM1",
            "pos": {
                "x": 52.849,
                "y": -55.812
            }
        },
        "endPos": { //结束点
            "instanceName": "LM2",
            "pos": {
                "x": 52.573,
                "y": -61.669
            }
        },
        "controlPosList": [
            {
                "x": 53.553, //靠近 startPos 弧线起始点
                "y": -56.404
            },
            {
                "x": 51.667, //弧线的圆心点
                "y": -58.648
            },
            {
                "x": 53.486, //靠近 endPos 弧线结束点
                "y": -60.947
            },
            {
                "x": 56.304, //2条弧线点延长线的焦点
                "y": -58.717
            }
        ],
        "property": [
            {
                "key": "direction",
                "type": "int",
                "value": "MA==",
                "int32Value": 0 //0正走 1倒走
            },
            {
                "key": "movestyle",
                "type": "int",
                "value": "MA==",
                "int32Value": 0
            }
        ]
    }

4.9 AdvancedArea 高级区域
{
    "className": "AdvancedArea", // [string] 高级区域类型
    "instanceName": "1", // [string] 区域唯一标识名
    "posGroup": [ // [MapPos[]] 区域顶点，首尾相连
        {
            "x": 1.889,
            "y": 2.250
        }, //左上
        {
            "x": 2.380,
            "y": 2.250
        }, //右上
        {
            "x": 2.380,
            "y": 1.751
        }, //右下
        {
            "x": 1.889,
            "y": 1.751
        }
    ], //左下
    "property": [] // (MapProperty[]) 属性数组
}
4.10 完整的地图
实际的地图对象，以上只是地图中会用到的对象的说明
{
    "mapDirectory": "", // (string) 暂时无用
    "header": { // [MapHeader] 地图头部
        "mapType": "2D-Map",
        "mapName": "test",
        "minPos": {
            "x": -43.800,
            "y": -70.200
        },
        "maxPos": {
            "x": 166.000,
            "y": 86.600
        },
        "resolution": 0.02,
        "version": "1.0.6"
    },
    "normalPosList": [ // (MapPos[]) 普通点数组
        {
            "x": -43.800,
            "y": -20.800
        },
        {
            "x": -43.600,
            "y": -20.600
        },
        {
            "x": -43.400,
            "y": -20.600
        }
    ],
    "rssiPosList": [ // (RSSIPos[]) 反光板点数组
        {
            "x": -4.800,
            "y": -3.800
        },
        {
            "x": -5.600,
            "y": -0.600
        }
    ],
    "normalLineList": [ // (MapLine[]) 普通线数组
        {
            "startPos": {
                "x": 59.280,
                "y": -24.420
            },
            "endPos": {
                "x": 63.270,
                "y": -22.280
            }
        },
        {
            "startPos": {
                "x": 116.540,
                "y": -52.120
            },
            "endPos": {
                "x": 145.040,
                "y": -51.880
            }
        }
    ],
    "advancedPointList": [ // (AdvancedPoint[]) 高级点数组
        {
            "className": "LocationdMark",
            "instanceName": "LM1",
            "pos": {
                "x": 18.420,
                "y": 9.270
            }
        },
        {
            "className": "LocationdMark",
            "instanceName": "LM2",
            "pos": {
                "x": 22.415,
                "y": 38.103
            },
            "property": [
                {
                    "key": "spin",
                    "type": "int32",
                    "value": "MQ==",
                    "int32Value": 1
                }
            ]
        },
        {
            "className": "LocationdMark",
            "instanceName": "LM3",
            "pos": {
                "x": 22.297,
                "y": 14.284
            },
            "property": [
                {
                    "key": "spin",
                    "type": "int32",
                    "value": "MQ==",
                    "int32Value": 1
                }
            ]
        },
        {
            "className": "LocationdMark",
            "instanceName": "LM4",
            "pos": {
                "x": 36.825,
                "y": -8.824
            },
            "property": [
                {
                    "key": "spin",
                    "type": "int32",
                    "value": "MQ==",
                    "int32Value": 1
                }
            ]
        }
    ],
    "advancedLineList": [ // (AdvancedLine[]) 高级线数组
        {
            "className": "ForbiddenLine",
            "instanceName": "1",
            "line": {
                "startPos": {
                    "x": 50.970,
                    "y": 28.460
                },
                "endPos": {
                    "x": 74.690,
                    "y": 28.460
                }
            }
        },
        {
            "className": "ForbiddenLine",
            "instanceName": "2",
            "line": {
                "startPos": {
                    "x": -18.460,
                    "y": 14.010
                },
                "endPos": {
                    "x": 3.280,
                    "y": 14.010
                }
            }
        }
    ],
    "advancedCurveList": [ // (AdvancedCurve[]) 高级曲线数组
        {
            "className": "BezierPath", // 连接上面高级点数组中 instanceName 为 LM1 和 LM2 的曲线
            "startPos": {
                "className": "LocationdMark",
                "instanceName": "LM1",
                "pos": {
                    "x": 18.420,
                    "y": 9.270
                }
            },
            "endPos": {
                "className": "LocationdMark",
                "instanceName": "LM2",
                "pos": {
                    "x": 22.415,
                    "y": 38.103
                }
            },
            "controlPos1": {
                "x": 22.009,
                "y": 28.664
            },
            "controlPos2": {
                "x": 22.369,
                "y": 20.501
            },
            "property": []
        },
        {
            "className": "BezierPath", // 连接上面高级点数组中 instanceName 为 LM3 和 LM4 的曲线
            "startPos": {
                "className": "LocationdMark",
                "instanceName": "LM3",
                "pos": {
                    "x": 22.297,
                    "y": 14.284
                }
            },
            "endPos": {
                "className": "LocationdMark",
                "instanceName": "LM4",
                "pos": {
                    "x": 36.825,
                    "y": -8.824
                }
            },
            "controlPos1": {
                "x": -32.702,
                "y": 6.313
            },
            "controlPos2": {
                "x": -30.231,
                "y": -3.313
            },
            "property": []
        }
    ],
    "advancedAreaList": [ // (AdvancedArea[]) 高级区域数组
        {
            "className": "AdvancedArea",
            "instanceName": "1",
            "posGroup": [
                {
                    "x": 1.889,
                    "y": 2.250
                },
                {
                    "x": 2.380,
                    "y": 2.250
                },
                {
                    "x": 2.380,
                    "y": 1.751
                },
                {
                    "x": 1.889,
                    "y": 1.751
                }
            ],
            "property": [
                {
                    "key": "ultrasonic",
                    "type": "bool",
                    "value": "ZmFsc2U=",
                    "boolValue": false
                },
                {
                    "key": "fallingdown",
                    "type": "bool",
                    "value": "ZmFsc2U=",
                    "boolValue": false
                }
            ]
        }
    ]
}
注：
1. 以上地图只是示例, 并不是一张可以使用的地图，实际可使用 Github 仓库中的示例地图测试。
2. 高级点 ( AdvancedPoint) 的点即为导航点，用户一般只需关心各种高级点以及连接它们的 BezierPath ( AdvancedCurve ) 即可。
3. 对于仅想解析地图用于绘制显示的用户，建议直接解析 JSON，而不是用 Protobuf，这样可以降低工作量。

五、声明

由于地图为我司自定义的私有格式，未来可能有所更改，不保证 100% 的向下兼容性。
